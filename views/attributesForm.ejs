<!DOCTYPE html>
<html>
<head>
    <% include partials/report/header %>
    <% include partials/master/header %>
    <link href="/query-builder/css/query-builder.default.css" rel="stylesheet">
</head>
<body class="fixed-navigation">
<script>
    var dataObj = null;
<%
    //  If editing, set segment variable to edit
    if (dataObj) {
%>
        <%- 'dataObj = ' + JSON.stringify(dataObj) + ';' %>
<%  }  %>

    var type = '<%- req.query.type %>';
    var title = type.substr(0, 1).toLocaleUpperCase() + type.substr(1);
</script>

<div id="wrapper">

    <% include partials/master/leftPanel %>

    <div id="page-wrapper" class="white-bg">

        <% include partials/master/topPanel %>

        <div class="wrapper wrapper-content">

            <div class="row white-bg">

                <% include partials/master/message %>

                <div class="col-lg-8">
                    <h1 id="title"></h1>
                    <br>
                    <form id="actionForm" role="form" onsubmit="return false">
                        <div class="form-group">
                            <label>Attribute name:</label>
                            <input type="text" id="name" name="name" class="form-control m-b">
                        </div>
                        <div class="form-group">
                            <br><label>Description (shows up on help):</label>
                            <input type="text" id="description" name="description" class="form-control m-b">
                        </div>
                    </form>
                </div>
            </div>
            <div class="row white-bg">
                <div class="col-lg-4">
                    <form id="actionForm2" role="form" onsubmit="return false">
                        <div class="form-group">
                            <br><label>What kind of attribute is this?</label>
                            <br><input type="radio" id="attribTypeElement" name="attribType" class="m-b" value="element" checked> <b>Element</b>:&nbsp; These are generally character or date values that can be grouped, sorted and filtered on.  An example of an element is 'Platform'.
                            <br><input type="radio" id="attribTypeMetric" name="attribType" class="m-b" value="metric"> <b>Metric</b>:&nbsp; These are numeric values that can be totaled, sorted and filtered on.  An example of a metric is 'Revenue'.
                        </div>
                    </form>
                </div>
                <div class="col-lg-4">
                    <h3>Example:</h3>
                    <form id="actionForm3" role="form" onsubmit="return false">
                        <table id="results-table-table" class="table table-striped table-bordered table-hover dataTable no-footer dtr-inline" style="width: 100%; margin: 0px;" role="grid" aria-describedby="results-table-table_info">
                            <thead>
                                <tr role="row">
                                    <th class="sorting" tabindex="0" aria-controls="results-table-table" rowspan="1" colspan="1" style="width: 291px;"><i>This is an element</i><br><br>Browser</th>
                                    <th class="dt-body-right sorting_desc" tabindex="0" aria-controls="results-table-table" rowspan="1" colspan="1" style="width: 174px;" aria-sort="descending"><i>This is a metric that is summed</i><br><br>Sessions</span> <br><div style="font-weight:500;font-size:1.4em;padding-top:3px">7,299</div></th>
                                </tr>
                            </thead>
                            <tbody><tr role="row" class="odd">
                                <td>Chrome</td>
                                <td class="dt-body-right sorting_1"><span style="display:none">0000000004332</span>4,332<div style="display:inline-block; font-size:.825em;font-weight:500;min-width:47px !important">&nbsp; (59.35%)</div></td>
                            </tr>
                            <tr role="row" class="even">
                                <td>Firefox</td>
                                <td class="dt-body-right sorting_1"><span style="display:none">0000000001452</span>1,452<div style="display:inline-block; font-size:.825em;font-weight:500;min-width:47px !important">&nbsp; (19.89%)</div></td>
                            </tr></tbody>
                        </table>
                    </form>
                </div>
            </div>

            <div class="row white-bg">
                <div class="col-lg-8">
                    <form id="actionForm3" role="form" onsubmit="return false">
                        <div id="elementOptions">
                            <div class="form-group">
                                <br><label>What kind of data will this attribute hold:</label>
                                <select class="form-control m-b" id="dataType" name="dataType">
                                    <option value="string">String (character data)</option>
                                    <option value="numeric">Number</option>
                                    <option value="date">Date</option>
                                    <option value="boolean">Boolean (true or false value)</option>
                                </select>
                            </div>
                        </div>
                        <div id="numericOptions">
                            <br><label>Display format: (<a href="/formatoptions">show options</a>)</label>
                            <br><input id="format" name="format" class="form-control m-b" value="0,0.00">
                        </div>
                        <div id="metricOptions">
                            <div class="form-group">
                                <label>Show totals on reports for this metric as:</label>
                                <br><input type="radio" id="totalSum" name="totalBy" class="m-b" value="sum" checked> Sum
                                <br><input type="radio" id="totalAvg" name="totalBy" class="m-b" value="average"> Average
                                <br><input type="radio" id="totalNone" name="totalBy" class="m-b" value="none"> None
                            </div>
                            <div class="form-group">
                                <br><label>Show relationship to total on reports for this metric by:</label>
                                <br><input type="radio" id="brPercent" name="basisRelationship" class="m-b" value="percent" checked> Percentage (for example, 12.2% of sessions)
                                <br><input type="radio" id="brRatio" name="basisRelationship" class="m-b" value="ratio"> Ratio (for example, 2.3 page views per session)
                            </div>
                        </div>
                        <div class="form-group">
                            <br><label>Should this attribute be included as a filter option on reports?</label>
                            <br><input type="radio" id="filterYes" name="filter" class="m-b" value="yes" checked> Yes
                            <br><input type="radio" id="filterNo" name="filter" class="m-b" value="no"> No
                        </div>
                        <div>
                            <br>
                            <button onclick="submitForm(); return false" class="btn btn-sm btn-primary m-t-n-xs" type="submit"><strong id="attributeSubmit">Create</strong></button>
                            <br><br><br><br><br><br><br>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <% include partials/master/footer %>
    </div>
</div>

<% include partials/master/footerScripts %>
<% include partials/report/footerScripts %>
<script src="/typeahead/typeahead.jquery.min.js"></script>
<script src="/js/moment.min.js"></script>

<script>

    function setFormData() {

        if (dataObj) {
            $('#title').html('Edit ' + title + ' Attribute for Project: <%- project.name %>');
            $('#name').val(dataObj.name);
            $('#name').prop('readonly', true);
            $('#description').val(dataObj.description);
            $('#attribTypeElement').prop('checked', dataObj.isElement);

            if (!dataObj.filterable)
                $('#filterNo').prop('checked',true);

            if (dataObj.isMetric) {
                $('#attribTypeMetric').prop('checked',true);
                $('#elementOptions').hide();
                $('#metricOptions').show();
            }

            if (dataObj.format)
                $('#format').val(dataObj.format);

            if (dataObj.totalBy)
                $('input:radio[name="totalBy"]').filter('[value="' + dataObj.totalBy + '"]').attr('checked', true);

            if (dataObj.basisRelationship)
                $('input:radio[name="basisRelationship"]').filter('[value="' + dataObj.basisRelationship + '"]').attr('checked', true);

            if (dataObj.dataType) {
                $('#dataType').val(dataObj.dataType);

                if (dataObj.dataType == 'numeric')
                    $('#numericOptions').show();
                else
                    $('#numericOptions').hide();
            }

            $('#attributeSubmit').html('Update Attribute');

        } else {
            $('#title').html('Create New ' + title + ' Attribute for Project: <%- project.name %>');
        }
    }

    function getFormData() {
        var params = {
            type: '<%- req.query.type %>',
            name: $('#name').val(),
            description: $('#description').val(),
            attribType: $('input:radio[name=attribType]:checked').val(),
            filterable: $('#filterYes').prop('checked') ? "yes" : "no",
            dataType: $('#dataType').val(),
            element: $('input:radio[name=element]:checked').val(),
            format: $('#format').val(),
            totalBy: $('input:radio[name=totalBy]:checked').val(),
            basisRelationship: $('input:radio[name=basisRelationship]:checked').val()
        };

        return params;
    }

    function submitForm() {

        if (!$('#name').val()) {
            Page.showMessage('You must enter a name for the attribute.')
            return;
        }

        if ($('#name').val().indexOf('.') > -1 || $('#name').val().indexOf('$') > -1 || $('#name').val().substr(0, 1) == '_') {
            Page.showMessage('The attribute name cannot contain a "." or "$" character or begin with a "_".')
            return;
        }

        //  validation passed, update the data
        Data.submitForm('/setup/attributes/<%- project.id %>', getFormData(), function() {
            window.location = '/setup/attributes/<%- project.id %>?type=<%- req.query.type %>';
        });
    }

    $(document).ready(function() {

        if ($('#attribTypeMetric').prop('checked')) {
            $('#dataType').val('numeric');
            $('#metricOptions').show();
            $('#elementOptions').hide();
        } else {
            $('#metricOptions').hide();
            $('#elementOptions').show();
        }

        if ($('#dataType').val() == 'numeric')
            $('#numericOptions').show();
        else
            $('#numericOptions').hide();

        $('[name="attribType"]').on("click", function() {

            if ($('#attribTypeElement').prop('checked')) {
                $('#elementOptions').show();
                $('#metricOptions').hide();
            } else {
                $('#elementOptions').hide();
                $('#metricOptions').show();
            }
        });

        $('[name="dataType"]').on("change", function() {

            if (this.value == 'numeric')
                $('#numericOptions').show();
            else
                $('#numericOptions').hide();
        });

        //  set up form based on whether a new item or editing an existing item
        setFormData();
    });
</script>
</body>
</html>
